---
alwaysApply: true
description: "Agent Behavior Rules for Nexflow Project"
language: ru
globs: ["**/*.go", "**/*.md", "config.*.yml", "config.*.yaml"]
---

# Cursor Agent Behavior for Nexflow

Вы работаете как ИИ-ассистент для проекта Nexflow.

## Главное правило (CRITICAL)

**Сначала прочитайте `AGENTS.md` в корне репозитория.**

## Как работать с проектом

### 1. Начало работы

1. **Прочитайте `AGENTS.md`**
2. **Прочитайте модули правил** по контексту:
   - Любая задача → `docs/rules/security.md` (ОБЯЗАТЕЛЬНО)
   - Любая задача → `docs/rules/projectrules.md`
   - Архитектура → `docs/rules/architecture.md`
   - Качество кода → `docs/rules/codequality.md`
   - API → `docs/rules/apidesign.md`
   - БД → `docs/rules/database.md`
   - Тесты → `docs/rules/testing.md`
3. **Изучите существующий код**
4. **Сформулируйте план**

### 2. Приоритеты правил

1. **Безопасность** (`docs/rules/security.md`) — **САМОЕ ВАЖНОЕ**
2. **Архитектура** (`docs/rules/architecture.md`)
3. **Качество кода** (`docs/rules/codequality.md`)
4. **Тесты** (`docs/rules/testing.md`)
5. **Удобство** — только если не противоречит вышеперечисленному

### 3. Специфика Nexflow

**Технологический стек:** Go 1.25.5, SQLC, slog, YAML/JSON с ${VAR_NAME}

**Архитектура:** Channels → Core Gateway → Storage/Skills

**LLM провайдеры:** Anthropic, OpenAI, Ollama, Google Gemini, z.ai, OpenRouter

**БД:** SQLite/Postgres, SQLC, connection pool (25 max, 5min lifetime)

**Логирование:** slog, JSON/text формат, маскирование секретов

### 4. Go-специфика

- Error wrapping: `fmt.Errorf("msg: %w", err)`
- Context для всех I/O операций
- Struct tags: `json:"field_name" yaml:"field_name"`
- Интерфейсы для тестирования
- `os.MkdirTemp()` для временных файлов

## Форматирование ответов

### Создание кода

1. Краткое описание
2. Код с комментариями
3. Объяснение архитектурных решений
4. Следующие шаги/тесты

### Исправление багов

1. Описание проблемы
2. Корневая причина
3. Испление
4. Профилактика

### Добавление фич

1. Описание фичи
2. Архитектурные изменения
3. Код с тестами
4. Обновление документации

## Запрещено

1. **НИКОГДА** не хардкодите секреты
2. **НИКОГДА** не создавайте циклические зависимости
3. **НИКОГДА** не игнорируйте ошибки
4. **НИКОГДА** не нарушайте слои архитектуры
5. **НИКОГДА** не коммитьте без тестов
6. **НИКОГДА** не коммитьте секреты

## Обязательно

1. **ВСЕГДА** используйте `context.Context` для I/O
2. **ВСЕГДА** оборачивайте ошибки с `%w`
3. **ВСЕГДА** пишите unit тесты
4. **ВСЕГДА** используйте интерфейсы для тестирования
5. **ВСЕГДА** маскируйте секреты в логах
6. **ВСЕГДА** валидируйте входные данные

## Workflow задач

1. Анализ (прочитать AGENTS.md и правила)
2. План (сформулировать план изменений)
3. Реализация (код + тесты)
4. Проверка (тесты, lint)
5. Завершение (коммит, push, документация)

## Дополнительные ресурсы

**Документация:**
- PRD: `docs/nexflow-prd-v2.md`
- Implementation: `docs/nexflow-implementation-plan.md`
- Database: `docs/database-config.md`
- Logging: `docs/LOGGING_INTEGRATION.md`
- SKILL: `docs/формат SKILL.md`

**Ключевые файлы:**
- `AGENTS.md` — главный вход
- `docs/rules/security.md` — безопасность (КРИТИЧНО!)
- `docs/rules/projectrules.md` — общие правила
- `docs/rules/architecture.md` — архитектура

## Заключение

**Помните:** Безопасность > Архитектура > Качество > Удобство

Если что-то неясно:
1. Проверьте `docs/rules/security.md` — безопасность приоритет
2. Проверьте соответствующие модули правил
3. Проверьте PRD для бизнес-контекста
4. Задайте вопрос или предложите улучшение

---

**Важное:** Всегда начинайте с чтения `AGENTS.md` и соблюдайте `docs/rules/security.md`!
